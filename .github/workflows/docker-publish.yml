name: Build and Push Docker Image

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'readme.md'
  schedule:
    - cron: '0 3 */2 * *'
  workflow_dispatch:

jobs:
  check_tag:
    name: Check latest codex tag
    runs-on: ubuntu-latest
    outputs:
      latest_tag: ${{ steps.latest.outputs.latest_tag }}
      prev_tag: ${{ steps.prev.outputs.prev_tag }}
      should_build: ${{ steps.decide.outputs.should_build }}
    steps:
      - name: Fetch latest tag from openai/codex
        id: latest
        run: |
          set -euo pipefail
          latest="$(git ls-remote --tags https://github.com/openai/codex.git \
            | awk -F/ '{print $NF}' \
            | sed 's/\^{}//' \
            | grep -E '^rust-v[0-9]+(\.[0-9]+)*$' \
            | sort -u -V \
            | tail -n1)"
          echo "latest_tag=$latest" >> "$GITHUB_OUTPUT"

      - name: Restore cached tag
        uses: actions/cache/restore@v4
        with:
          path: .cache
          key: codex-tag-${{ steps.latest.outputs.latest_tag }}
          restore-keys: |
            codex-tag-

      - name: Read previous tag
        id: prev
        run: |
          set -euo pipefail
          if [ -f .cache/codex_tag.txt ]; then
            prev="$(cat .cache/codex_tag.txt)"
          else
            prev=""
          fi
          echo "prev_tag=$prev" >> "$GITHUB_OUTPUT"

      - name: Decide whether to build
        id: decide
        run: |
          set -euo pipefail
          latest="${{ steps.latest.outputs.latest_tag }}"
          prev="${{ steps.prev.outputs.prev_tag }}"
          if [ "${{ github.event_name }}" != "schedule" ]; then
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          elif [ -z "$prev" ]; then
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          elif [ "$latest" != "$prev" ]; then
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_build=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Decision summary
        run: |
          echo "Latest tag: ${{ steps.latest.outputs.latest_tag }}"
          echo "Cached tag: ${{ steps.prev.outputs.prev_tag }}"
          echo "Should build: ${{ steps.decide.outputs.should_build }}"

  build:
    name: Build ${{ matrix.dist }} ${{ matrix.arch }}
    needs: check_tag
    if: needs.check_tag.outputs.should_build == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          # alpine
          - dist: alpine
            build_image: docker.io/rust:alpine
            base_image: docker.io/alpine:latest
            arch: amd64
            runs_on: ubuntu-latest
          - dist: alpine
            build_image: docker.io/rust:alpine
            base_image: docker.io/alpine:latest
            arch: arm64
            runs_on: ubuntu-24.04-arm
          # debian
          - dist: debian
            build_image: docker.io/rust:slim-trixie
            base_image: docker.io/debian:trixie-slim
            arch: amd64
            runs_on: ubuntu-latest
          - dist: debian
            build_image: docker.io/rust:slim-trixie
            base_image: docker.io/debian:trixie-slim
            arch: arm64
            runs_on: ubuntu-24.04-arm
          # fedora
          - dist: fedora
            build_image: quay.io/fedora/fedora-minimal:latest
            base_image: quay.io/fedora/fedora-minimal:latest
            arch: amd64
            runs_on: ubuntu-latest
          - dist: fedora
            build_image: quay.io/fedora/fedora-minimal:latest
            base_image: quay.io/fedora/fedora-minimal:latest
            arch: arm64
            runs_on: ubuntu-24.04-arm


    runs-on: ${{ matrix.runs_on }}

    steps:
      - name: zram
        run: |
          sudo apt install -y linux-modules-extra-$(uname -r)
          sudo modprobe zram
          dev=$(sudo zramctl --find --algorithm zstd --size 32G)
          sudo mkswap $dev
          sudo swapon --priority 100 $dev

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        uses: redhat-actions/podman-login@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Container image
        uses: redhat-actions/buildah-build@v2
        with:
          image: ghcr.io/${{ github.repository }}
          tags: ci-${{ matrix.dist }}-${{ matrix.arch }}
          containerfiles: ./dockerfile
          build-args: |
            DIST=${{ matrix.dist }}
            BUILD_IMAGE=${{ matrix.build_image }}
            BASE_IMAGE=${{ matrix.base_image }}
            CODEX_TAG=${{ needs.check_tag.outputs.latest_tag }}

      - name: Save OCI archive
        run: |
          mkdir -p out
          podman save --format oci-archive -o "out/${{ matrix.dist }}-${{ matrix.arch }}.tar" "ghcr.io/${{ github.repository }}:ci-${{ matrix.dist }}-${{ matrix.arch }}"

      - name: Upload OCI archive
        uses: actions/upload-artifact@v4
        with:
          name: image-${{ matrix.dist }}-${{ matrix.arch }}
          path: out/${{ matrix.dist }}-${{ matrix.arch }}.tar
          retention-days: 1
          compression-level: 0


  manifest:
    name: Manifest push ${{ matrix.dist }}
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - dist: alpine
            tags: "latest alpine"
          - dist: debian
            tags: "debian"
          - dist: fedora
            tags: "fedora"

    steps:
      - name: Download OCI archives
        uses: actions/download-artifact@v4
        with:
          pattern: image-${{ matrix.dist }}-*
          path: in
          merge-multiple: true

      - name: Load images into local storage
        run: |
          set -euo pipefail
          for arch in amd64 arm64; do
            podman load -i "in/${{ matrix.dist }}-${arch}.tar"
          done

      - name: Log in to GitHub Container Registry
        uses: redhat-actions/podman-login@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create & push multi-arch tags
        run: |
          set -euxo pipefail
          IMAGE="ghcr.io/${{ github.repository }}"
          AMD="${IMAGE}:ci-${{ matrix.dist }}-amd64"
          ARM="${IMAGE}:ci-${{ matrix.dist }}-arm64"

          for t in ${{ matrix.tags }}; do
            podman manifest rm "${IMAGE}:${t}" 2>/dev/null || true
            podman manifest create "${IMAGE}:${t}"
            podman manifest add "${IMAGE}:${t}" "containers-storage:${AMD}"
            podman manifest add "${IMAGE}:${t}" "containers-storage:${ARM}"
            podman manifest push --all "${IMAGE}:${t}" "docker://${IMAGE}:${t}"
          done

      - name: Save latest tag cache
        if: ${{ needs.build.result == 'success' }}
        run: |
          set -euo pipefail
          mkdir -p .cache
          echo "${{ needs.check_tag.outputs.latest_tag }}" > .cache/codex_tag.txt

      - name: Persist tag cache
        if: ${{ needs.build.result == 'success' }}
        uses: actions/cache/save@v4
        with:
          path: .cache
          key: codex-tag-${{ needs.check_tag.outputs.latest_tag }}
